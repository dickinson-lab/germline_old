<head>
    <title> <TMPL_VAR NAME="TITLE"> </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>
        $(document).ready(function run_optimizer() {
            var input = {
                name: '<TMPL_VAR NAME="SEQ_NAME">',
                DNAseq: '<TMPL_VAR NAME="DNA_SEQ">',
                AAseq: '<TMPL_VAR NAME="AA_SEQ">',
                seqtype: '<TMPL_VAR NAME="SEQ_TYPE">',
                add_introns: '<TMPL_VAR NAME="INTRONS">'
            }
            //This AJAX call kicks off the calculation
            $.ajax({
                type: "POST",
                url: "libs/optimizer-js2.pl",
                data: { data: JSON.stringify(input) },
                timeout: 3600000,
                dataType: "html",
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    if (errorThrown == "timeout") {
                        $("#stuff").html( "<h2> Timeout error </h2>" + 
                                          "<p> Your request took too long to process.  Please try again. <br/>" +
                                          "If you continue to experience this error, contact ddickins@live.unc.edu for help. </p>");
                    } else {
                        $("#stuff").html( "<h2> Program error </h2>" + 
                                          "<p>" + errorThrown + "</p>");
                    }
                }, 
                success: function( jobID ) {
                    
                    // setInterval is a weird JS way of running a loop every few seconds
                    var intervalHandle = setInterval( function() { // Code below is the loop body
                        
                        //This AJAX call checks to see if the process is still running
                        $.ajax({
                            type: "HEAD",
                            url: jobID + "_running.pid",
                            cache: false,
                            async: false,
                            success: function() { // If we found the file, then the process is still running
                                $("#test").text( "PID file found!");
                            },
                            error: function (jqXHR1, textStatus1, errorThrown1) { // An error here may indicate that the process is complete
                                // This AJAX call tries to load the result file
                                $.ajax({
                                    type: "GET",
                                    url: jobID + "_results.dat",
                                    async: false,
                                    success: function() { // If we found the results file, then the process is complete; display results
                                        // Code to display results
                                        $("#test").text( "Results file found!" );
                                    },
                                    error: function (jqXHR2, textStatus2, errorThrown2) { // If this one throws an error, then we have no PID file and no results file; this is bad.
                                        $("#stuff").html( "<h2> Program error </h2>" + 
                                                          "<p> Could not locate PID file or results file. </p>" +
                                                          "<p> Contact ddickins@live.unc.edu for help </p>" );
                                    }
                                });
                            }
                        });
                        
                    }, 15000); // Number here is the frequency with which the event runs (check status every 15s)
                }
            });
        });
    </script>
</head>

<body>
    <div id='stuff'>
        <div style=text-align:center>
            <h2> Waiting for results... </h2>
            <p id=response> Your results will appear here when they are ready. </p>
            <p id=test> File not found. </p>
            <img src="libs/roller.gif" alt="Roller" style="width:150px;height:150px">
        </div>
    </div>
</body>